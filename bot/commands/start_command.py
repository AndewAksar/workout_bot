# bot/handlers/start_command.py
"""
–ú–æ–¥—É–ª—å: start_command.py
–û–ø–∏—Å–∞–Ω–∏–µ: –ú–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start.

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- sqlite3: –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö SQLite.
- telegram: –î–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Telegram API.
- telegram.ext: –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ Telegram.
- bot.config.settings: –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (WELCOME_MESSAGE).
- bot.keyboards.main_menu: –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.

–ê–≤—Ç–æ—Ä: Aksarin A.
–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 19/08/2025
"""

import sqlite3
from telegram import Update
from telegram.ext import ContextTypes

from bot.config.settings import WELCOME_MESSAGE
from bot.keyboards.main_menu import get_main_menu


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
        –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start.

        –û–ø–∏—Å–∞–Ω–∏–µ:
            –í—ã–ø–æ–ª–Ω—è–µ—Ç –Ω–∞—á–∞–ª—å–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ–≥–æ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
            –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (ID, –∏–º—è, username) –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ—ë.
            –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é.

        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
            update (telegram.Update): –û–±—ä–µ–∫—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ö–æ–¥—è—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.
            context (telegram.ext.ContextTypes.DEFAULT_TYPE): –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –±–æ—Ç–∞.

        –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:
            None

        –ò—Å–∫–ª—é—á–µ–Ω–∏—è:
            - sqlite3.Error: –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
            - telegram.error.TelegramError: –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

        –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É /start, –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
    """
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ–±—ä–µ–∫—Ç–∞ Update
    user = update.message.from_user
    user_id = user.id
    username = user.username if user.username else "–¥—Ä—É–≥"
    first_name = user.first_name if user.first_name else ""

    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    conn = sqlite3.connect('users.db')
    c = conn.cursor()
    c.execute(
        "INSERT OR REPLACE INTO UserSettings (user_id, username, name) VALUES (?, ?, ?)",
        (user_id, username, first_name)
    )
    conn.commit()

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    c.execute(
        "SELECT name, age, weight, height, training_type FROM UserSettings WHERE user_id = ?",
        (user_id,)
    )
    profile = c.fetchone()
    conn.close()

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    greeting = (
        f"<b>–ü—Ä–∏–≤–µ—Ç, {profile[0] or username}! üëã</b>\n"
        f"–¢–≤–æ–π ID: <code>{user_id}</code>\n\n"
    )
    if profile and any(profile[1:]):  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
        greeting += (
            f"\nüìã <b>–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å:</b>\n"
            f"–í–æ–∑—Ä–∞—Å—Ç: {profile[1] if profile[1] else '–ù–µ —É–∫–∞–∑–∞–Ω'}\n"
            f"–í–µ—Å: {profile[2] if profile[2] else '–ù–µ —É–∫–∞–∑–∞–Ω'} –∫–≥\n"
            f"–†–æ—Å—Ç: {profile[3] if profile[3] else '–ù–µ —É–∫–∞–∑–∞–Ω'} —Å–º\n"
            f"–¢–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: {profile[4] if profile[4] else '–ù–µ —É–∫–∞–∑–∞–Ω'}\n"
        )
    greeting += f"{WELCOME_MESSAGE}"

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é
    await update.message.reply_text(
        greeting,
        parse_mode="HTML",
        reply_markup=get_main_menu()
    )